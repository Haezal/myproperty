(function(e){var a={csrfToken:null,csrfTokenName:null,nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function t(t,s){var n=e.extend({},a,s);var o=n.csrfToken?"&"+n.csrfTokenName+"="+n.csrfToken:"";var r={};var i=e(t);if(!n.hasName){if(!n.hasDesc){i.addClass("no-name-no-desc");e(".edit_selected",i).hide()}else i.addClass("no-name")}else if(!n.hasDesc)i.addClass("no-desc");var c=e(".sorter",i);var l=e(".images",c);var d=e(".editor-modal",i);var p=e(".progress-overlay",i);var h=e(".upload-progress",p);var f=e(".form",d);function v(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function u(a,t,s,o){var r='<div class="photo-editor">'+'<div class="preview"><img src="'+v(t)+'" alt=""/></div>'+"<div>"+(n.hasName?'<label for="photo_name_'+a+'">'+n.nameLabel+":</label>"+'<input type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+v(s)+'" id="photo_name_'+a+'"/>':"")+(n.hasDesc?'<label for="photo_description_'+a+'">'+n.descriptionLabel+":</label>"+'<textarea name="photo['+a+'][description]" rows="3" cols="40" class="input-xlarge" id="photo_description_'+a+'">'+v(o)+"</textarea>":"")+"</div>"+"</div>";return e(r)}var m='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(n.hasName)m+="<h5></h5>";if(n.hasDesc)m+="<p></p>";m+='</div><div class="actions">';if(n.hasName||n.hasDesc)m+='<span class="editPhoto btn btn-primary btn-mini"><i class="icon-pencil icon-white"></i></span> ';m+='<span class="deletePhoto btn btn-danger btn-mini"><i class="icon-remove icon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';function g(a,t,s,o,i){var c=e(m);r[a]=c;c.data("id",a);c.data("rank",i);e("img",c).attr("src",t);if(n.hasName)e(".caption h5",c).text(s);if(n.hasDesc)e(".caption p",c).text(o);l.append(c);return c}function k(a){var t=a.length;var s=f.empty();for(var n=0;n<t;n++){var o=a[n];var i=r[o],c=e("img",i).attr("src"),l=e(".caption h5",i).text(),p=e(".caption p",i).text();s.append(u(o,c,l,p))}if(t>0)d.modal("show")}function D(a){e.ajax({type:"POST",url:n.deleteUrl,data:"id[]="+a.join("&id[]=")+o,success:function(e){if(e=="OK"){for(var t=0,s=a.length;t<s;t++){r[a[t]].remove();delete r[a[t]]}}else alert(e)}})}function b(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");D([s]);return false}function w(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");k([s]);return false}function T(){var a=e(".photo.selected",c).length;e(".select_all",i).prop("checked",e(".photo",c).length==a);if(a==0){e(".edit_selected, .remove_selected",i).addClass("disabled")}else{e(".edit_selected, .remove_selected",i).removeClass("disabled")}}function _(){var a=e(this);if(a.is(":checked"))a.closest(".photo").addClass("selected");else a.closest(".photo").removeClass("selected");T()}l.on("click",".photo .deletePhoto",b).on("click",".photo .editPhoto",w).on("click",".photo .photo-select",_);e(".images",c).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var a=[];e(".photo",c).each(function(){var t=e(this);a.push("order["+t.data("id")+"]="+t.data("rank"))});e.ajax({type:"POST",url:n.arrangeUrl,data:a.join("&")+o,dataType:"json"}).done(function(e){for(var a in e[a]){r[a].data("rank",e[a])}})});if(window.FormData!==undefined){var x=e(".afile",i).attr("name");function N(e){if(e.length==0)return;p.show();h.css("width","5%");var a=e.length;var t=0;var s=[];for(var o=0;o<a;o++){var r=new FormData;r.append(x,e[o]);if(n.csrfToken){r.append(n.csrfTokenName,n.csrfToken)}var i=new XMLHttpRequest;i.open("POST",n.uploadUrl,true);i.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);g(e["id"],e["preview"],e["name"],e["description"],e["rank"]);s.push(e["id"])}else{}h.css("width",""+(5+95*t/a)+"%");console.log(t);if(t===a){h.css("width","100%");p.hide();if(n.hasName||n.hasDesc)k(s)}};i.send(r)}}(function(){var e=i[0];var a=false;var t=false;setInterval(function(){if(a!=t){if(a)e.classList.add("over");else e.classList.remove("over");t=a}},30);function s(e){e.preventDefault();a=true;return false}function n(){a=false;return false}function o(e){e.preventDefault();e.stopPropagation();var t=e.dataTransfer.files;N(t);a=false;return false}function r(){a=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",n,false);e.addEventListener("drop",o,false);e.addEventListener("dragend",r,false)})();e(".afile",i).attr("multiple","true").on("change",function(e){e.preventDefault();N(this.files)})}else{e(".afile",i).on("change",function(a){a.preventDefault();var t=[];p.show();h.css("width","5%");var s={};if(n.csrfToken)s[n.csrfTokenName]=n.csrfToken;e.ajax({type:"POST",url:n.uploadUrl,data:s,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){g(e["id"],e["preview"],e["name"],e["description"],e["rank"]);t.push(e["id"]);h.css("width","100%");p.hide();if(n.hasName||n.hasDesc)k(t)})})}e(".save-changes",d).click(function(a){a.preventDefault();e.post(n.updateUrl,e("input, textarea",f).serialize()+o,function(a){var t=a.length;for(var s=0;s<t;s++){var o=a[s];var l=r[o.id];e("img",l).attr("src",o["src"]);if(n.hasName)e(".caption h5",l).text(o["name"]);if(n.hasDesc)e(".caption p",l).text(o["description"])}d.modal("hide");e(".photo.selected",c).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",i).prop("checked",false);T()},"json")});e(".edit_selected",i).click(function(a){a.preventDefault();var t=[];e(".photo.selected",c).each(function(){t.push(e(this).data("id"))});k(t);return false});e(".remove_selected",i).click(function(a){a.preventDefault();var t=[];e(".photo.selected",c).each(function(){t.push(e(this).data("id"))});D(t)});e(".select_all",i).change(function(){if(e(this).prop("checked")){e(".photo",c).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",c).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}T()});for(var y=0,L=n.photos.length;y<L;y++){var C=n.photos[y];g(C["id"],C["preview"],C["name"],C["description"],C["rank"])}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){t(this,e)})}}})(jQuery);